<?
//////////////////////////////////////////////////////////////////////////////////////////////////////
//
//	SCRIPT: mySQL.php	- provides regular mySQL maintance functions
//
//	02.15.2014	|	js	|	prototyped
//	02.17.2014	|	js	|	extended: draw(select, where)
//						|	accepts k->v func->"name"
//	02.18.2014	|	js	|	fails more gracefully
//						|	extended: update(select, where)
//
//	TODOs:	return one dimensional array if appropriate
//
//////////////////////////////////////////////////////////////////////////////////////////////////////

//var_dump($_REQUEST);

//	Includes	//////////////////////////////////////////////////////////////////////////////////////?>
<?
//////////////////////////////////////////////////////////////////////////////////////////////////////

//	Controller	//////////////////////////////////////////////////////////////////////////////////////

switch(isset($_REQUEST['func'])) {
	case 'select':
		select($_REQUEST['select'], $_REQUEST['where']);
		break;
	case 'draw':
		draw($_REQUEST['select'], $_REQUEST['where']);
		break;
	case 'update':
		update($_REQUEST['select'], $_REQUEST['where']);
		break;
}

//////////////////////////////////////////////////////////////////////////////////////////////////////

function select($select, $where = "") {

	//	Includes	//////////////////////////////////////////////////////////////////////////////////
	
	require_once('includes/connectvars.php');
	
	//////////////////////////////////////////////////////////////////////////////////////////////////
	
	//	Data	//////////////////////////////////////////////////////////////////////////////////////
	
	$mysqli	= new mysqli(DB_HOST, DB_USER, DB_PASSWORD, DB_NAME);
	
//	var_dump($where);
	
//	$select = $mysqli->real_escape_string($select);
//	$where	= $mysqli->real_escape_string($where);
	
//	var_dump($where);
	
	$query	= [
		"select"	=> "$select",
		"where"		=> "$where"
	];
	
	if(empty($where)) {
		unset($query["where"]);
	}
	
	$query = implode(' ', $query);
	
//	var_dump($query);
	
	//////////////////////////////////////////////////////////////////////////////////////////////////
	
	//	Logic	//////////////////////////////////////////////////////////////////////////////////////
	
	/* check connection */
	if (mysqli_connect_errno()) {
	    printf("Connect failed: %s\n", mysqli_connect_error());
	    exit();
	}
	
	if ($result = $mysqli->query($query)) {
	
	    /* fetch associative array */
	    while ($row = $result->fetch_assoc()) {
			$rows[] = $row;
	    }
	
	    /* free result set */
	    $result->free();
	} else {
		var_dump($query);
		printf("Returned no results.");
		exit();
	}
	
	/* close connection */
	$mysqli->close();	
	
	//////////////////////////////////////////////////////////////////////////////////////////////////
	
	//	Output	//////////////////////////////////////////////////////////////////////////////////////
	
	if(isset($rows)){
		return $rows;		
	}
	
	//////////////////////////////////////////////////////////////////////////////////////////////////

}

function draw($select, $where = '') {
	
	//	Data	//////////////////////////////////////////////////////////////////////////////////////

	$data = select($select, $where);
//	var_dump($data);
	
	//////////////////////////////////////////////////////////////////////////////////////////////////
		
	//	Output	//////////////////////////////////////////////////////////////////////////////////////
	
	if(!empty($data)) {?>
		<table>
			<tr>
				<?foreach ($keys = array_keys($data[0]) as $key) {?>
					<th><?=$key;?></th>
				<?} unset( $key );?>
			</tr>
			<?foreach ($data as $row) {?>
			<tr>
				<?foreach ( $values = array_values($row) as $value ) {?>
					<td><?=$value;?></td>
				<?}?>
			</tr>	
			<?}?>
		</table><?		
	} else {?>
		<p class="error">No Results Found</p><?
	}

	//////////////////////////////////////////////////////////////////////////////////////////////////
}

function drawEditable($select, $where = '') {
	
	//	Data	//////////////////////////////////////////////////////////////////////////////////////

	$data = select($select, $where);
//	var_dump($data);
	
	//////////////////////////////////////////////////////////////////////////////////////////////////
	
	//	Controller	//////////////////////////////////////////////////////////////////////////////////?>
	
	<script>
        $(document).ready(function () {
            $('#editableTabularData').dataTable();
        });
    </script>
	<?
	//////////////////////////////////////////////////////////////////////////////////////////////////
		
	//	Output	//////////////////////////////////////////////////////////////////////////////////////
	
	if(!empty($data)) {?>
		<button id="btnAddNewRow">Add</button>
		<button id="btnDeleteRow">Delete</button>
	
		<table id="editableTabularData">
			<thead>
				<tr>
					<?foreach ($keys = array_keys($data[0]) as $key) {?>
						<th><?=$key;?></th>
					<?} unset( $key );?>
				</tr>
			</thead>
			<tbody>
				<?foreach ($data as $row) {?>
				<tr id="<?=$data['id'];?>">
					<?foreach ( $values = array_values($row) as $value ) {?>
						<td><?=$value;?></td>
					<?}?>
				</tr>	
				<?}?>
			</tbody>
		</table><?		
	} else {?>
		<p class="error">No Results Found</p><?
	}

	//////////////////////////////////////////////////////////////////////////////////////////////////
}

function update($select, $where='') {
	
	//	Includes	//////////////////////////////////////////////////////////////////////////////////
	
	require_once('includes/connectvars.php');
	
	//////////////////////////////////////////////////////////////////////////////////////////////////
	
	//	Data	//////////////////////////////////////////////////////////////////////////////////////
	
	$mysqli	= new mysqli(DB_HOST, DB_USER, DB_PASSWORD, DB_NAME);
	
//	var_dump($where);
	
//	$select = $mysqli->real_escape_string($select);
//	$where	= $mysqli->real_escape_string($where);
	
//	var_dump($where);
	
	$query	= [
		"select"	=> "$select",
		"where"		=> "$where"
	];
	
	if(empty($where)) {
		unset($query["where"]);
	}
	
	$query = implode(' ', $query);
	
//	var_dump($query);
	
	//////////////////////////////////////////////////////////////////////////////////////////////////
	
	//	Logic	//////////////////////////////////////////////////////////////////////////////////////
	
	/* check connection */
	if (mysqli_connect_errno()) {
	    printf("Connect failed: %s\n", mysqli_connect_error());
	    exit();
	}
	
	$result = $mysqli->query($query);
	if(!$result) {
		printf("Returned no results.");
		exit();
	}
	
	/* close connection */
	$mysqli->close();	
	
	//////////////////////////////////////////////////////////////////////////////////////////////////
	
	//	Output	//////////////////////////////////////////////////////////////////////////////////////
		
	//////////////////////////////////////////////////////////////////////////////////////////////////
}